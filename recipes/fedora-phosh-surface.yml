# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json

# Fedora Phosh Surface - Phase 1: Working Phosh on Stock Kernel
# =============================================================
# This recipe builds a functional Phosh mobile shell on Fedora Atomic
# using the stock Fedora kernel. Surface-specific hardware support
# (touchscreen, pen, cameras) will be added in Phase 2.
#
# See SURFACE-KERNEL-ROADMAP.md for the path to full Surface support.

name: fedora-phosh-surface
description: Fedora Atomic with Phosh shell for Microsoft Surface devices (Phase 1 - Stock Kernel)

base-image: quay.io/fedora/fedora-bootc
image-version: "42"

modules:
  # ============================================================================
  # STAGE 1: Add linux-surface repository
  # ============================================================================
  # We add the repo now for userspace tools, even without the kernel
  - type: script
    snippets:
      - |
        echo "=== Adding linux-surface repository for userspace tools ==="
        rpm --import https://pkg.surfacelinux.com/fedora/linux-surface.pub
        curl -L -o /etc/yum.repos.d/linux-surface.repo https://pkg.surfacelinux.com/fedora/linux-surface.repo

  # ============================================================================
  # STAGE 2: Install Surface userspace tools (no kernel dependency)
  # ============================================================================
  - type: dnf
    install:
      packages:
        # These work without the Surface kernel and improve touch/stylus
        - iptsd                    # Intel Precision Touch & Stylus Daemon
        - libwacom-surface         # Surface-specific libwacom data

  # ============================================================================
  # STAGE 3: Install Phosh Desktop Environment and Core Components
  # ============================================================================
  - type: dnf
    install:
      install-weak-deps: false
      packages:
        # === Phosh Shell Core ===
        - phosh
        - phoc
        - squeekboard
        
        # === Display Manager ===
        - gdm
        
        # === GNOME Components (required by Phosh) ===
        - gnome-session
        - gnome-settings-daemon
        - gnome-control-center
        - gnome-keyring
        - gnome-software
        
        # === Mobile-Friendly Apps ===
        - gnome-contacts
        - gnome-calendar
        - gnome-clocks
        - gnome-weather
        - gnome-calculator
        - gnome-text-editor
        - gnome-console
        - epiphany
        - nautilus
        
        # === Networking & Connectivity ===
        - NetworkManager
        - NetworkManager-wifi
        - ModemManager
        - bluez
        
        # === Hardware Support ===
        - iio-sensor-proxy         # Accelerometer, ambient light sensor
        - power-profiles-daemon
        - upower
        
        # === Audio ===
        - pipewire
        - pipewire-pulseaudio
        - wireplumber
        
        # === Mobile UX ===
        - feedbackd                # Haptic/sound feedback
        
        # === Portals & Flatpak ===
        - xdg-desktop-portal
        - xdg-desktop-portal-gnome
        - xdg-desktop-portal-gtk
        - flatpak
        
        # === System ===
        - polkit
        - dbus-daemon

  # ============================================================================
  # STAGE 4: Copy configuration files
  # ============================================================================
  - type: files
    files:
      - source: system
        destination: /

  # ============================================================================
  # STAGE 5: Phosh-specific configuration
  # ============================================================================
  - type: script
    scripts:
      - phosh-setup.sh

  # ============================================================================
  # STAGE 6: Enable systemd services
  # ============================================================================
  - type: systemd
    system:
      enabled:
        - gdm.service
        - NetworkManager.service
        - bluetooth.service
        - iptsd.service            # Touch daemon (works partially without Surface kernel)
        - power-profiles-daemon.service
        - feedbackd.service
        - iio-sensor-proxy.service
      disabled:
        - sshd.service

  # ============================================================================
  # STAGE 7: Set graphical target
  # ============================================================================
  - type: script
    snippets:
      - "systemctl set-default graphical.target"

  # ============================================================================
  # STAGE 8: Flatpak apps
  # ============================================================================
  - type: default-flatpaks
    system:
      repo-url: https://dl.flathub.org/repo/flathub.flatpakrepo
      repo-name: flathub
      install:
        - org.gnome.Loupe
        - org.gnome.Evince
        - org.gnome.Maps