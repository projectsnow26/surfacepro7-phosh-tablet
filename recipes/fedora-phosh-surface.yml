# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json

name: fedora-phosh-surface
description: Fedora Atomic with Phosh shell optimized for Microsoft Surface devices
base-image: quay.io/fedora/fedora-bootc
image-version: "42"

modules:
  # ============================================================================
  # STAGE 1: Prepare Surface Repository
  # ============================================================================
  - type: script
    snippets:
      # Import the GPG key properly to avoid dnf errors later
      - rpm --import https://pkg.surfacelinux.com/fedora/linux-surface.pub
      # Download the repo file
      - curl -L -o /etc/yum.repos.d/linux-surface.repo https://pkg.surfacelinux.com/fedora/linux-surface.repo

  # ============================================================================
  # STAGE 2: Install Phosh & Core Packages (Standard Fedora Kernel)
  # ============================================================================
  - type: dnf
    install:
      install-weak-deps: false
      packages:
        # Core Phosh
        - phosh
        - phoc
        - squeekboard
        - gdm
        
        # GNOME Apps & Utils
        - gnome-session
        - gnome-settings-daemon
        - gnome-control-center
        - gnome-software
        - gnome-console
        - nautilus
        - epiphany
        - gnome-contacts
        - gnome-weather
        - gnome-calculator
        
        # Hardware
        - NetworkManager-wifi
        - bluez
        - iptsd
        - libwacom-surface
        - iio-sensor-proxy
        - power-profiles-daemon
        - feedbackd

  # ============================================================================
  # STAGE 3: Configuration
  # ============================================================================
  - type: files
    files:
      - source: system
        destination: /

  - type: script
    scripts:
      - phosh-setup.sh

  - type: systemd
    system:
      enabled:
        - gdm.service
        - iptsd.service
        - feedbackd.service
      disabled:
        - sshd.service

  - type: default-flatpaks
    system:
      repo-url: https://dl.flathub.org/repo/flathub.flatpakrepo
      repo-name: flathub
      install:
        - org.gnome.Loupe
        - org.gnome.Maps

  # ============================================================================
  # STAGE 4: The Critical Kernel Swap & Cleanup
  # ============================================================================
  # We do this LAST to minimize the chance of 'dnf' pulling the old kernel back
  # as a dependency for some other package.
  - type: script
    snippets:
      - echo "=== STARTING KERNEL SWAP ==="
      
      # 1. Swap the kernel packages
      # We explicitly target kernel-core and kernel-modules to force the swap
      - dnf swap -y kernel-core kernel-surface-core --allowerasing
      - dnf swap -y kernel-modules kernel-surface-modules --allowerasing
      - dnf swap -y kernel-modules-extra kernel-surface-modules-extra --allowerasing || true
      
      # 2. Ensure the meta-package is present
      - dnf install -y kernel-surface
      
      # 3. THE FIX: Aggressively remove any packages related to the old kernel
      # This catches edge cases like 'kernel-modules-core' that 'swap' might miss.
      - dnf remove -y kernel-core kernel-modules kernel-modules-core || true
      
      # 4. NUCLEAR CLEANUP: Physically delete the old kernel directory.
      # bootc lint checks /usr/lib/modules/ count. It MUST be 1.
      - echo "Removing non-surface kernel directories..."
      - find /usr/lib/modules -maxdepth 1 -mindepth 1 -type d -not -name "*surface*" -exec rm -rf {} +
      
      # 5. Verification for the build logs
      - echo "Final /usr/lib/modules content (Must be exactly one directory):"
      - ls -la /usr/lib/modules
  # ============================================================================
  # STAGE 5: Systemd Services
  # ============================================================================
  - type: systemd
    system:
      enabled:
        - gdm.service
        - NetworkManager.service
        - bluetooth.service
        - iptsd.service
        - power-profiles-daemon.service
        - feedbackd.service
        - iio-sensor-proxy.service
      disabled:
        - sshd.service

  # ============================================================================
  # STAGE 6: Set Default Target
  # ============================================================================
  - type: script
    snippets:
      - "systemctl set-default graphical.target"

  # ============================================================================
  # STAGE 7: Flatpaks
  # ============================================================================
  - type: default-flatpaks
    system:
      repo-url: https://dl.flathub.org/repo/flathub.flatpakrepo
      repo-name: flathub
      install:
        - org.gnome.Loupe
        - org.gnome.Evince
        - org.gnome.Maps

  # ============================================================================
  # STAGE 8: Regenerate Initramfs (Must be last)
  # ============================================================================
  - type: initramfs