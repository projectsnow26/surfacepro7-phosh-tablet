# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json

name: fedora-phosh-surface
description: Fedora Atomic with Phosh shell optimized for Microsoft Surface devices
base-image: quay.io/fedora/fedora-bootc
image-version: "42" # Ensure this matches the Fedora version you intend to use

modules:
  # ============================================================================
  # STAGE 1: Swap Kernel and Cleanup (The "Nuclear" Option)
  # ============================================================================
  - type: script
    snippets:
      # 1. Force-download the Surface Linux repository file first
      # This prevents the "No match for argument: kernel-surface-core" error
      - curl -L -o /etc/yum.repos.d/linux-surface.repo https://pkg.surfacelinux.com/fedora/linux-surface.repo
      
      # 2. Perform the kernel swap
      - echo "Swapping Fedora kernel for Surface kernel..."
      # We use --nogpgcheck temporarily to avoid interactive key prompts breaking the build
      - dnf -y swap kernel-core kernel-surface-core --allowerasing --nogpgcheck
      - dnf -y swap kernel-modules kernel-surface-modules --allowerasing --nogpgcheck
      # The extra modules swap might fail if the original didn't have extras, so we allow failure (|| true)
      - dnf -y swap kernel-modules-extra kernel-surface-modules-extra --allowerasing --nogpgcheck || true
      
      # 3. Install the meta-package and surface utilities
      - dnf -y install kernel-surface iptsd libwacom-surface --nogpgcheck
      
      # 4. CRITICAL FIX: Manually remove leftover stock kernel modules
      # bootc lint fails if /usr/lib/modules contains more than one directory.
      # We delete any directory here that does NOT contain "surface" in its name.
      - echo "Cleaning up orphaned kernel module directories..."
      - find /usr/lib/modules -maxdepth 1 -mindepth 1 -type d -not -name "*surface*" -exec rm -rf {} +
      
      # 5. Verification (Outputs to log so you can confirm only one folder exists)
      - echo "Kernel modules directory content (Should show only one folder):"
      - ls -la /usr/lib/modules

  # ============================================================================
  # STAGE 2: Install Phosh Desktop Environment
  # ============================================================================
  - type: dnf
    install:
      install-weak-deps: false   # Keep image lean
      packages:
        # Core Phosh components
        - phosh
        - phoc
        - squeekboard
        - gdm
        
        # GNOME infrastructure
        - gnome-session
        - gnome-settings-daemon
        - gnome-control-center
        - gnome-keyring
        - gnome-software
        
        # Mobile-friendly Apps
        - gnome-contacts
        - gnome-calendar
        - gnome-clocks
        - gnome-weather
        - gnome-calculator
        - gnome-text-editor
        - gnome-console
        - epiphany
        - nautilus
        
        # Hardware Support
        - NetworkManager
        - NetworkManager-wifi
        - ModemManager
        - bluez
        - iio-sensor-proxy
        - power-profiles-daemon
        - upower
        - feedbackd
        
        # Audio
        - pipewire
        - pipewire-pulseaudio
        - wireplumber
        
        # Portals & Flatpak
        - xdg-desktop-portal
        - xdg-desktop-portal-gnome
        - xdg-desktop-portal-gtk
        - flatpak
        
        # System Utils
        - polkit
        - dbus-daemon

  # ============================================================================
  # STAGE 3: Configuration Files
  # ============================================================================
  - type: files
    files:
      - source: system
        destination: /

  # ============================================================================
  # STAGE 4: Custom Setup Scripts
  # ============================================================================
  - type: script
    scripts:
      - phosh-setup.sh

  # ============================================================================
  # STAGE 5: Systemd Services
  # ============================================================================
  - type: systemd
    system:
      enabled:
        - gdm.service
        - NetworkManager.service
        - bluetooth.service
        - iptsd.service
        - power-profiles-daemon.service
        - feedbackd.service
        - iio-sensor-proxy.service
      disabled:
        - sshd.service

  # ============================================================================
  # STAGE 6: Set Default Target
  # ============================================================================
  - type: script
    snippets:
      - "systemctl set-default graphical.target"

  # ============================================================================
  # STAGE 7: Flatpaks
  # ============================================================================
  - type: default-flatpaks
    system:
      repo-url: https://dl.flathub.org/repo/flathub.flatpakrepo
      repo-name: flathub
      install:
        - org.gnome.Loupe
        - org.gnome.Evince
        - org.gnome.Maps

  # ============================================================================
  # STAGE 8: Regenerate Initramfs (Must be last)
  # ============================================================================
  - type: initramfs