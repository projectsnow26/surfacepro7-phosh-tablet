# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json

name: fedora-phosh-surface
description: Fedora Atomic with Phosh shell optimized for Microsoft Surface devices
base-image: quay.io/fedora/fedora-bootc
image-version: "42" # Ensure this matches the Fedora version you intend to use

modules:
  # ============================================================================
  # STAGE 1: Swap Kernel and Cleanup (The "Nuclear" Option)
  # ============================================================================
  - type: script
    snippets:
      # 1. Setup Surface Repo
      - curl -L -o /etc/yum.repos.d/linux-surface.repo https://pkg.surfacelinux.com/fedora/linux-surface.repo
      
      # 2. Perform the Swap (ignoring GPG checks for the build process)
      - echo "Swapping Fedora kernel for Surface kernel..."
      - dnf -y swap kernel-core kernel-surface-core --allowerasing --nogpgcheck
      - dnf -y swap kernel-modules kernel-surface-modules --allowerasing --nogpgcheck
      - dnf -y swap kernel-modules-extra kernel-surface-modules-extra --allowerasing --nogpgcheck || true
      
      # 3. Install Surface Utilities
      - dnf -y install kernel-surface iptsd libwacom-surface --nogpgcheck
      
      # 4. CRITICAL FIX: Manually remove leftover stock kernel modules
      # bootc lint fails if /usr/lib/modules contains more than one directory.
      # We delete any directory here that does NOT contain "surface" in its name.
      - echo "Cleaning up orphaned kernel module directories..."
      - find /usr/lib/modules -maxdepth 1 -mindepth 1 -type d -not -name "*surface*" -exec rm -rf {} +
      - echo "Kernel modules directory content:"
      - ls -la /usr/lib/modules

  # ============================================================================
  # STAGE 2: Install Phosh Desktop Environment
  # ============================================================================
  - type: dnf
    install:
      install-weak-deps: false
      packages:
        # Core Phosh
        - phosh
        - phoc
        - squeekboard
        - gdm
        
        # GNOME Base
        - gnome-session
        - gnome-settings-daemon
        - gnome-control-center
        - gnome-keyring
        - gnome-software
        
        # Apps
        - gnome-contacts
        - gnome-calendar
        - gnome-clocks
        - gnome-weather
        - gnome-calculator
        - gnome-text-editor
        - gnome-console
        - epiphany
        - nautilus
        
        # Hardware/System
        - NetworkManager
        - NetworkManager-wifi
        - ModemManager
        - bluez
        - iio-sensor-proxy
        - power-profiles-daemon
        - upower
        - pipewire
        - pipewire-pulseaudio
        - wireplumber
        - feedbackd
        - polkit
        - dbus-daemon
        
        # Portals & Flatpak
        - xdg-desktop-portal
        - xdg-desktop-portal-gnome
        - xdg-desktop-portal-gtk
        - flatpak

  # ============================================================================
  # STAGE 3: System Configuration
  # ============================================================================
  - type: files
    files:
      - source: system
        destination: /

  - type: script
    scripts:
      - phosh-setup.sh

  - type: systemd
    system:
      enabled:
        - gdm.service
        - NetworkManager.service
        - bluetooth.service
        - iptsd.service
        - power-profiles-daemon.service
        - feedbackd.service
        - iio-sensor-proxy.service
      disabled:
        - sshd.service

  - type: script
    snippets:
      - "systemctl set-default graphical.target"

  - type: default-flatpaks
    system:
      repo-url: https://dl.flathub.org/repo/flathub.flatpakrepo
      repo-name: flathub
      install:
        - org.gnome.Loupe
        - org.gnome.Evince
        - org.gnome.Maps

  # ============================================================================
  # STAGE 4: Initramfs (Must be last to capture kernel changes)
  # ============================================================================
  - type: initramfs